{% extends "reception/base.html" %}

{% block reception_content %}
<div style="padding: 2rem;">
    <h1 style="font-size: 2rem; font-weight: 700; color: #2c3e50; margin-bottom: 2rem;">
        <i class="fas fa-chart-line"></i> Reception Dashboard
    </h1>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <!-- stylelint-disable-next-line -->
                <div style="padding: 1rem; border: 1px solid #dee2e6; border-left: 4px solid {% if category == 'error' %}#e74c3c{% elif category == 'success' %}#27ae60{% else %}#3498db{% endif %}; border-radius: 6px; margin-bottom: 1rem; background: {% if category == 'error' %}#fef5f5{% elif category == 'success' %}#f0fdf4{% else %}#f0f7ff{% endif %};" class="alert">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    <!-- Stats Cards -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
        <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">Total Messages</p>
                    <p style="font-size: 2.5rem; font-weight: 700; color: #0066cc;">{{ total_messages }}</p>
                </div>
                <i class="fas fa-envelope" style="font-size: 3rem; color: #0066cc; opacity: 0.2;"></i>
            </div>
        </div>
        
        <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">Unread</p>
                    <p style="font-size: 2.5rem; font-weight: 700; color: #e74c3c;">{{ unread_messages }}</p>
                </div>
                <i class="fas fa-bell" style="font-size: 3rem; color: #e74c3c; opacity: 0.2;"></i>
            </div>
        </div>
        
        <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">Pending</p>
                    <p style="font-size: 2.5rem; font-weight: 700; color: #f39c12;">{{ pending_messages }}</p>
                </div>
                <i class="fas fa-hourglass-end" style="font-size: 3rem; color: #f39c12; opacity: 0.2;"></i>
            </div>
        </div>
    </div>

    <!-- Emergency Stats (Live) -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
        <div style="background: #fff; padding: 1rem; border-radius: 8px; border-left: 4px solid #c62828; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <p style="margin: 0 0 0.35rem; color: #6b7280; font-size: 0.86rem;">Emergency Calls Today</p>
            <p id="emergencyTodayStat" style="margin: 0; font-size: 1.9rem; font-weight: 700; color: #c62828;">{{ emergency_today_calls }}</p>
        </div>
        <div style="background: #fff; padding: 1rem; border-radius: 8px; border-left: 4px solid #ef6c00; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <p style="margin: 0 0 0.35rem; color: #6b7280; font-size: 0.86rem;">Emergency Active</p>
            <p id="emergencyActiveStat" style="margin: 0; font-size: 1.9rem; font-weight: 700; color: #ef6c00;">{{ emergency_active_calls }}</p>
        </div>
        <div style="background: #fff; padding: 1rem; border-radius: 8px; border-left: 4px solid #2e7d32; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <p style="margin: 0 0 0.35rem; color: #6b7280; font-size: 0.86rem;">Emergency Answered</p>
            <p id="emergencyAnsweredStat" style="margin: 0; font-size: 1.9rem; font-weight: 700; color: #2e7d32;">{{ emergency_answered_calls }}</p>
        </div>
    </div>

    <!-- Live Emergency Queue -->
    <div style="background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 1.5rem; margin-bottom: 2rem; border-left: 4px solid #c62828;">
        <h2 style="font-size: 1.25rem; font-weight: 600; color: #2c3e50; margin-bottom: 1rem;">
            <i class="fas fa-triangle-exclamation" style="color: #c62828;"></i> Emergency Queue (Live)
        </h2>
        <div id="emergencyQueueList" style="display: flex; flex-direction: column; gap: 0.75rem;">
            {% if pending_emergency_calls %}
                {% for call in pending_emergency_calls %}
                    <div style="padding: 1rem; background: #fff4f4; border: 1px solid #f6d2d2; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4 style="font-weight: 600; color: #2c3e50; margin-bottom: 0.25rem;">
                                <i class="fas fa-user-circle"></i> {{ call.patient_name }}
                            </h4>
                            <p style="color: #666; font-size: 0.9rem; margin: 0;">
                                <i class="fas fa-phone"></i> {{ call.patient_phone }}
                            </p>
                            <small style="display: inline-block; margin-top: 0.35rem; padding: 0.15rem 0.45rem; border-radius: 999px; background: #eef4ff; color: #2c3e50; font-size: 0.75rem; text-transform: capitalize;">
                                {{ call.status.replace('_', ' ') }}
                            </small>
                            <small style="color: #999;">Received at {{ call.created_at.strftime('%I:%M %p') }}</small>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="answerCallFromDashboard('{{ call.call_id }}')" style="padding: 0.5rem 1rem; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                                <i class="fas fa-phone-alt"></i> Answer
                            </button>
                            <button onclick="rejectCallFromDashboard('{{ call.call_id }}')" style="padding: 0.5rem 1rem; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                                <i class="fas fa-phone-slash"></i> Reject
                            </button>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p style="margin: 0; color: #6b7280; text-align: center; padding: 1rem;">No emergency calls in queue.</p>
            {% endif %}
        </div>
    </div>
    
    <!-- Pending Calls -->
    {% if pending_calls %}
    <div style="background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 1.5rem; margin-bottom: 2rem; border-left: 4px solid #e74c3c;">
        <h2 style="font-size: 1.25rem; font-weight: 600; color: #2c3e50; margin-bottom: 1rem;">
            <i class="fas fa-phone" style="color: #e74c3c;"></i> Incoming Calls
        </h2>
        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
            {% for call in pending_calls %}
                <div style="padding: 1rem; background: #fef5f5; border: 1px solid #f5d5d1; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h4 style="font-weight: 600; color: #2c3e50; margin-bottom: 0.25rem;">
                            <i class="fas fa-user-circle"></i> {{ call.patient_name }}
                        </h4>
                        <p style="color: #666; font-size: 0.9rem; margin: 0;">
                            <i class="fas fa-phone"></i> {{ call.patient_phone }}
                        </p>
                        <small style="display: inline-block; margin-top: 0.35rem; padding: 0.15rem 0.45rem; border-radius: 999px; background: #eef4ff; color: #2c3e50; font-size: 0.75rem; text-transform: capitalize;">
                            {{ call.status.replace('_', ' ') }}
                        </small>
                        <small style="color: #999;">Called at {{ call.created_at.strftime('%I:%M %p') }}</small>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button onclick="answerCallFromDashboard('{{ call.call_id }}')" style="padding: 0.5rem 1rem; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; transition: all 0.3s;" onmouseover="this.style.background='#229954'" onmouseout="this.style.background='#27ae60'">
                            <i class="fas fa-phone-alt"></i> {{ 'Connect' if call.status in ['busy', 'on_hold'] else 'Answer' }}
                        </button>
                        <button onclick="rejectCallFromDashboard('{{ call.call_id }}')" style="padding: 0.5rem 1rem; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; transition: all 0.3s;" onmouseover="this.style.background='#c0392b'" onmouseout="this.style.background='#e74c3c'">
                            <i class="fas fa-phone-slash"></i> Reject
                        </button>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- Recent Communications -->
    <div style="background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 1.5rem; margin-bottom: 2rem;">
        <h2 style="font-size: 1.25rem; font-weight: 600; color: #2c3e50; margin-bottom: 1rem;">
            <i class="fas fa-history"></i> Recent Communications
        </h2>
        
        {% if recent_communications %}
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 2px solid #dee2e6;">
                        <th style="padding: 1rem; text-align: left; font-weight: 600; color: #666;">From</th>
                        <th style="padding: 1rem; text-align: left; font-weight: 600; color: #666;">Type</th>
                        <th style="padding: 1rem; text-align: left; font-weight: 600; color: #666;">Message</th>
                        <th style="padding: 1rem; text-align: left; font-weight: 600; color: #666;">Status</th>
                        <th style="padding: 1rem; text-align: left; font-weight: 600; color: #666;">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for comm in recent_communications %}
                        <tr style="border-bottom: 1px solid #dee2e6; transition: all 0.3s;">
                            <td style="padding: 1rem;">
                                <strong>{{ comm.patient_name }}</strong><br>
                                <small style="color: #666;">{{ comm.patient_email }}</small>
                            </td>
                            <td style="padding: 1rem;">
                                <!-- stylelint-disable-next-line -->
                                <span style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem; font-weight: 500; background: {% if comm.message_type == 'call' %}#e3f2fd{% elif comm.message_type == 'email' %}#f3e5f5{% else %}#e8f5e9{% endif %}; color: {% if comm.message_type == 'call' %}#1976d2{% elif comm.message_type == 'email' %}#7b1fa2{% else %}#388e3c{% endif %};">
                                    {{ comm.message_type }}
                                </span>
                            </td>
                            <td style="padding: 1rem;">
                                <div style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    {{ comm.message_content[:50] }}...
                                </div>
                            </td>
                            <td style="padding: 1rem;">
                                {% if comm.is_resolved %}
                                    <span style="color: #27ae60; font-weight: 500;">✓ Resolved</span>
                                {% elif comm.reply_content %}
                                    <span style="color: #3498db; font-weight: 500;">✓ Replied</span>
                                {% else %}
                                    <span style="color: #e74c3c; font-weight: 500;">● Pending</span>
                                {% endif %}
                            </td>
                            <td style="padding: 1rem;">
                                <a href="{{ url_for('view_communication', message_id=comm.id) }}" style="color: #0066cc; text-decoration: none; font-weight: 500;">View</a>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p style="color: #666; text-align: center; padding: 2rem;">No communications yet</p>
        {% endif %}
    </div>
    
    <!-- Notifications -->
    <div style="background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 1.5rem;">
        <h2 style="font-size: 1.25rem; font-weight: 600; color: #2c3e50; margin-bottom: 1rem;">
            <i class="fas fa-bell"></i> Recent Notifications
        </h2>
        
        {% if unread_notifications %}
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                {% for notif in unread_notifications %}
                    <div style="padding: 1rem; border-left: 4px solid #0066cc; background: #f0f7ff; border-radius: 4px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h4 style="font-weight: 600; color: #2c3e50; margin-bottom: 0.5rem;">{{ notif.title }}</h4>
                                <p style="color: #666; font-size: 0.9rem;">{{ notif.message }}</p>
                                <small style="color: #999;">{{ notif.created_at.strftime('%b %d, %Y at %I:%M %p') }}</small>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p style="color: #666; text-align: center; padding: 2rem;">No new notifications</p>
        {% endif %}
    </div>
</div>

<script>
    (function() {
        let emergencyReceiveTimer = null;

        function escapeHtml(value) {
            return String(value || '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        function updateEmergencyStats(stats) {
            if (!stats || typeof stats !== 'object') return;
            const todayNode = document.getElementById('emergencyTodayStat');
            const activeNode = document.getElementById('emergencyActiveStat');
            const answeredNode = document.getElementById('emergencyAnsweredStat');

            if (todayNode) todayNode.textContent = Number(stats.today_calls || 0);
            if (activeNode) activeNode.textContent = Number(stats.active_calls || 0);
            if (answeredNode) answeredNode.textContent = Number(stats.answered_calls || 0);
        }

        function renderEmergencyQueue(calls) {
            const queueNode = document.getElementById('emergencyQueueList');
            if (!queueNode) return;

            if (!Array.isArray(calls) || calls.length === 0) {
                queueNode.innerHTML = '<p style="margin: 0; color: #6b7280; text-align: center; padding: 1rem;">No emergency calls in queue.</p>';
                return;
            }

            queueNode.innerHTML = calls.map((call) => {
                const callId = escapeHtml(call.call_id);
                const patientName = escapeHtml(call.patient_name || 'Caller');
                const patientPhone = escapeHtml(call.patient_phone || 'SYSTEM');
                const callStatus = escapeHtml((call.status || 'ringing').replaceAll('_', ' '));
                const createdAt = escapeHtml(call.created_at || '');

                return `
                    <div style="padding: 1rem; background: #fff4f4; border: 1px solid #f6d2d2; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4 style="font-weight: 600; color: #2c3e50; margin-bottom: 0.25rem;">
                                <i class="fas fa-user-circle"></i> ${patientName}
                            </h4>
                            <p style="color: #666; font-size: 0.9rem; margin: 0;">
                                <i class="fas fa-phone"></i> ${patientPhone}
                            </p>
                            <small style="display: inline-block; margin-top: 0.35rem; padding: 0.15rem 0.45rem; border-radius: 999px; background: #eef4ff; color: #2c3e50; font-size: 0.75rem; text-transform: capitalize;">
                                ${callStatus}
                            </small>
                            <small style="color: #999;">Received at ${createdAt}</small>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="answerCallFromDashboard('${callId}')" style="padding: 0.5rem 1rem; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                                <i class="fas fa-phone-alt"></i> Answer
                            </button>
                            <button onclick="rejectCallFromDashboard('${callId}')" style="padding: 0.5rem 1rem; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                                <i class="fas fa-phone-slash"></i> Reject
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function refreshEmergencyReceive() {
            try {
                const response = await fetch('/api/reception/emergency-receive', {
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                const data = await response.json();
                if (!response.ok || !data.success) return;
                updateEmergencyStats(data.stats || {});
                renderEmergencyQueue(data.calls || []);
            } catch (error) {
                // Keep UI state as-is during temporary network failures.
            }
        }

        function startEmergencyReceivePolling() {
            if (emergencyReceiveTimer) return;
            refreshEmergencyReceive();
            emergencyReceiveTimer = setInterval(refreshEmergencyReceive, 7000);
        }

        function stopEmergencyReceivePolling() {
            if (!emergencyReceiveTimer) return;
            clearInterval(emergencyReceiveTimer);
            emergencyReceiveTimer = null;
        }

        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopEmergencyReceivePolling();
                return;
            }
            startEmergencyReceivePolling();
        });

        document.addEventListener('DOMContentLoaded', () => {
            startEmergencyReceivePolling();
        });
    })();
</script>
{% endblock %}
