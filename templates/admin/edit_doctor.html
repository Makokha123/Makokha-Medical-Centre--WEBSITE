{% extends "admin/base.html" %}

{% block title %}Edit Doctor - Admin Panel{% endblock %}
{% block page_title %}Edit Doctor: {{ doctor.full_name() }}{% endblock %}

{% block extra_css %}
<style>
    .doctor-image-editor {
        border: 1px solid #ceddf0;
        border-radius: 10px;
        background: #ffffff;
        padding: 0.55rem;
        margin-bottom: 0.75rem;
    }

    .doctor-image-stage {
        position: relative;
        width: 100%;
        max-width: 360px;
        aspect-ratio: 4 / 5;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #d6e3f3;
        background: #0f2f4e;
        cursor: grab;
        touch-action: none;
    }

    .doctor-image-stage.dragging {
        cursor: grabbing;
    }

    .doctor-adjust-image {
        display: block;
        width: 100%;
        height: 100%;
        object-fit: cover;
        pointer-events: none;
        user-select: none;
    }

    .doctor-image-toolbar {
        margin-top: 0.45rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .doctor-position-label {
        font-size: 0.78rem;
        color: #607186;
        white-space: nowrap;
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-form-layout">
    <div class="admin-page-intro">
        <h1><i class="fas fa-user-edit"></i> Edit Doctor</h1>
        <p>Update profile, contact, and availability details.</p>
    </div>

    <form method="POST" enctype="multipart/form-data" class="admin-form-shell">
        <input type="hidden" id="doctorImagePositionJson" name="doctor_image_position_json" value='{{ doctor_focus|tojson }}'>
        <h3 class="admin-form-title">Professional Information</h3>

        <div class="admin-grid-2">
            <div class="form-group">
                <label class="form-label">First Name</label>
                <input type="text" name="first_name" class="form-control" value="{{ doctor.first_name }}" required>
            </div>

            <div class="form-group">
                <label class="form-label">Last Name</label>
                <input type="text" name="last_name" class="form-control" value="{{ doctor.last_name }}" required>
            </div>
        </div>

        <div class="admin-grid-2">
            <div class="form-group">
                <label class="form-label">Specialty</label>
                <input type="text" name="specialty" class="form-control" value="{{ doctor.specialty }}" required>
            </div>

            <div class="form-group">
                <label class="form-label">Qualification</label>
                <input type="text" name="qualification" class="form-control" value="{{ doctor.qualification or '' }}">
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Bio</label>
            <textarea name="bio" class="form-textarea">{{ doctor.bio or '' }}</textarea>
        </div>

        <h3 class="admin-form-title" style="margin-top: 0.35rem;">Contact & Availability</h3>

        <div class="admin-grid-2">
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" name="email" class="form-control" value="{{ doctor.email or '' }}">
            </div>

            <div class="form-group">
                <label class="form-label">Phone</label>
                <input type="tel" name="phone" class="form-control" value="{{ doctor.phone or '' }}">
            </div>
        </div>

        <div class="admin-grid-2">
            <div class="form-group">
                <label class="form-label">Available Days</label>
                <input type="text" name="available_days" class="form-control" value="{{ doctor.available_days or '' }}">
            </div>

            <div class="form-group">
                <label class="form-label">Consulting Hours</label>
                <input type="text" name="consulting_hours" class="form-control" value="{{ doctor.consulting_hours or '' }}">
            </div>
        </div>

        <div class="form-group">
            <label class="form-label">Doctor Photo</label>
            <div class="doctor-image-editor" id="doctorImageEditor" {% if not doctor.image_filename %}hidden{% endif %}>
                <div class="doctor-image-stage" id="doctorImageStage">
                    {% if doctor.image_filename %}
                    <img
                        src="{{ url_for('static', filename='uploads/' + doctor.image_filename) }}"
                        alt="{{ doctor.full_name() }}"
                        id="doctorImagePreview"
                        class="doctor-adjust-image"
                        style="object-position: {{ '%.2f'|format(doctor_focus.x) }}% {{ '%.2f'|format(doctor_focus.y) }}%;"
                    >
                    {% else %}
                    <img src="" alt="Doctor photo preview" id="doctorImagePreview" class="doctor-adjust-image">
                    {% endif %}
                </div>
                <div class="doctor-image-toolbar">
                    <small class="admin-field-note">Current photo. Drag to adjust visible area.</small>
                    <span class="doctor-position-label" id="doctorImagePositionLabel">{{ '%.0f'|format(doctor_focus.x) }}% x / {{ '%.0f'|format(doctor_focus.y) }}% y</span>
                </div>
            </div>
            <input type="file" id="doctorImageInput" name="image" class="form-control" accept="image/*">
            <small class="admin-field-note">Leave blank to keep current photo. If you upload a new one, preview above updates and remains draggable.</small>
        </div>

        <div class="admin-form-actions">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Update Doctor
            </button>
            <a href="{{ url_for('admin_doctors') }}" class="btn btn-outline">
                <i class="fas fa-times"></i> Cancel
            </a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    (function initDoctorImageEditor() {
        const hiddenInput = document.getElementById('doctorImagePositionJson');
        const fileInput = document.getElementById('doctorImageInput');
        const editor = document.getElementById('doctorImageEditor');
        const stage = document.getElementById('doctorImageStage');
        const image = document.getElementById('doctorImagePreview');
        const label = document.getElementById('doctorImagePositionLabel');
        if (!hiddenInput || !fileInput || !editor || !stage || !image) return;

        const clamp = (value, min, max) => Math.min(max, Math.max(min, value));

        let position = { x: 50, y: 50 };
        try {
            const parsed = JSON.parse(hiddenInput.value || '{}');
            position = {
                x: clamp(Number(parsed.x) || 50, 0, 100),
                y: clamp(Number(parsed.y) || 50, 0, 100)
            };
        } catch (error) {
            position = { x: 50, y: 50 };
        }

        const sync = () => {
            hiddenInput.value = JSON.stringify(position);
            image.style.objectPosition = `${position.x.toFixed(2)}% ${position.y.toFixed(2)}%`;
            if (label) {
                label.textContent = `${Math.round(position.x)}% x / ${Math.round(position.y)}% y`;
            }
        };
        sync();

        let dragging = false;
        let startX = 0;
        let startY = 0;
        let originX = position.x;
        let originY = position.y;

        stage.addEventListener('pointerdown', (event) => {
            if (editor.hidden) return;
            dragging = true;
            startX = event.clientX;
            startY = event.clientY;
            originX = position.x;
            originY = position.y;
            stage.classList.add('dragging');
            stage.setPointerCapture(event.pointerId);
            event.preventDefault();
        });

        stage.addEventListener('pointermove', (event) => {
            if (!dragging) return;
            const width = Math.max(stage.clientWidth, 1);
            const height = Math.max(stage.clientHeight, 1);
            const dx = event.clientX - startX;
            const dy = event.clientY - startY;
            position.x = clamp(originX + ((dx / width) * 100), 0, 100);
            position.y = clamp(originY + ((dy / height) * 100), 0, 100);
            sync();
        });

        const stopDragging = (event) => {
            if (!dragging) return;
            dragging = false;
            stage.classList.remove('dragging');
            try {
                stage.releasePointerCapture(event.pointerId);
            } catch (error) {
                // no-op
            }
        };

        stage.addEventListener('pointerup', stopDragging);
        stage.addEventListener('pointercancel', stopDragging);
        stage.addEventListener('lostpointercapture', stopDragging);

        fileInput.addEventListener('change', () => {
            const file = fileInput.files && fileInput.files[0];
            if (!file) return;
            image.src = URL.createObjectURL(file);
            editor.hidden = false;
            sync();
        });
    })();
</script>
{% endblock %}
